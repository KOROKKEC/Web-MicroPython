<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web MicroPython</title>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Core libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ESP Web Tools: used for ESP series firmware flashing (requires HTTPS / localhost) -->
    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module">
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        md: {
                            base: '#101418',
                            surface: '#1a1c1e',
                            surface2: '#202429',
                            primary: '#a8c7fa',
                            onPrimary: '#003355',
                            secondary: '#4fd8eb',
                            danger: '#ffb4ab',
                            success: '#b6f2ba',
                            warning: '#efb8c8'
                        }
                    },
                    borderRadius: { '3xl': '1.5rem', '4xl': '2rem' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #101418; color: #e2e2e6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444746; border-radius: 99px; }
        
        .btn-material { @apply flex items-center justify-center gap-2 px-4 py-2 rounded-full transition-all duration-200 font-medium select-none cursor-pointer active:scale-95; }
        .btn-icon { @apply p-2 rounded-full hover:bg-white/10 transition-colors cursor-pointer text-gray-400 hover:text-white; }
        .btn-filled { @apply bg-md-primary text-md-onPrimary hover:opacity-90 shadow-lg shadow-blue-900/20; }
        .btn-tonal { @apply bg-[#334455] text-md-primary hover:bg-[#3f5060]; }
        .btn-text { @apply text-gray-400 hover:text-white hover:bg-white/5; }
        
        .file-item { @apply px-4 py-3 rounded-r-full mr-2 cursor-pointer flex items-center gap-3 text-sm text-gray-400 transition-colors border-l-4 border-transparent hover:bg-white/5; }
        .file-item.active { @apply bg-[#004a77] text-blue-200 border-md-primary; }

        .modal-bg { @apply fixed inset-0 bg-black/70 z-50 flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300; }
        .modal-bg.show { @apply opacity-100; }
        .modal-content { @apply bg-md-surface2 w-full max-w-2xl rounded-3xl p-6 shadow-2xl transform scale-95 transition-transform duration-300 border border-gray-700; }
        .modal-bg.show .modal-content { @apply scale-100; }

        .sidebar-mobile { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-hidden { transform: translateX(-100%); }

        .esp-flasher-modal {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            width: 95%;
            max-width: 500px;
            background-color: #1a1c1e;
            border-radius: 1.5rem;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: none;
        }
        .esp-flasher-modal.show {
            display: block;
        }

        esp-web-install-button {
            --esp-tools-button-border-radius: 9999px;
        }

        .btn-disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* marker for Google Translate */
        .notranslate { }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden relative selection:bg-md-primary selection:text-md-onPrimary">

    <!-- First-time welcome overlay -->
    <div id="welcomeModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-md-surface2 w-full max-w-4xl mx-3 rounded-3xl border border-gray-800 shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-start justify-between gap-4">
                <div>
                    <div class="inline-flex items-center gap-2 rounded-full bg-md-surface px-3 py-1 border border-gray-700 text-[11px] text-gray-400 mb-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.8)]"></span>
                        <span>First-time guide</span>
                    </div>
                    <h2 class="text-xl font-semibold text-white">
                        Welcome to <span class="text-md-primary">Web MicroPython</span>
                    </h2>
                    <p class="text-[12px] text-gray-400 mt-1 max-w-xl">
                        This IDE lets you connect to a MicroPython board, browse files, edit code, run scripts,
                        and flash ESP firmware – all directly inside your browser.
                    </p>
                    <p class="text-[12px] text-gray-400 mt-1 max-w-xl">
                        You can also install this site as an application and launch it offline from your desktop or start menu
                        after the first successful load.
                    </p>
                </div>
                <button class="btn-icon" type="button" data-welcome-close>
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="mt-4 grid md:grid-cols-2 gap-4">
                <div class="space-y-3 text-[12px] text-gray-200">
                    <div class="flex items-start gap-2">
                        <div class="mt-0.5 w-7 h-7 rounded-2xl bg-md-surface flex items-center justify-center border border-gray-700 text-md-secondary">
                            <i class="fa-solid fa-usb text-[11px]"></i>
                        </div>
                        <div>
                            <div class="font-semibold">Connect via Web Serial</div>
                            <p class="text-[12px] text-gray-400 mt-0.5">
                                Use Chrome or Edge, and open this IDE over <code>https://</code> or <code>http://localhost</code>
                                to allow access to the serial port.
                            </p>
                        </div>
                    </div>

                    <div class="flex items-start gap-2">
                        <div class="mt-0.5 w-7 h-7 rounded-2xl bg-md-surface flex items-center justify-center border border-gray-700 text-md-primary">
                            <i class="fa-solid fa-file-code text-[11px]"></i>
                        </div>
                        <div>
                            <div class="font-semibold">Edit and run MicroPython code</div>
                            <p class="text-[12px] text-gray-400 mt-0.5">
                                Use the Explorer to open files from the board, edit them in the central editor,
                                save changes back, and run scripts while watching output in the Shell.
                            </p>
                        </div>
                    </div>

                    <div class="flex items-start gap-2">
                        <div class="mt-0.5 w-7 h-7 rounded-2xl bg-md-surface flex items-center justify-center border border-gray-700 text-amber-300">
                            <i class="fa-solid fa-bolt text-[11px]"></i>
                        </div>
                        <div>
                            <div class="font-semibold">Flash ESP firmware</div>
                            <p class="text-[12px] text-gray-400 mt-0.5">
                                Click the yellow lightning icon in the toolbar to open the Flash toolbox and
                                burn MicroPython firmware to ESP32 / ESP8266 series boards.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 text-[12px] text-gray-200">
                    <div class="rounded-3xl bg-md-surface border border-gray-700 p-3">
                        <div class="text-[11px] font-semibold text-gray-300 mb-1 flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-md-primary text-[10px]"></i>
                            Quick checklist
                        </div>
                        <ul class="space-y-1 text-[12px] text-gray-400">
                            <li>• Chrome or Edge with Web Serial support.</li>
                            <li>• Access over <code>https://</code> or <code>http://localhost</code>.</li>
                            <li>• A supported MCU board (ESP32 / ESP8266 series, etc.) and USB cable.</li>
                            <li>• MicroPython firmware installed, or ready to be flashed.</li>
                            <li>• You can install this page as an app and use it offline after it has been opened once.</li>
                        </ul>
                    </div>

                    <div class="rounded-3xl bg-md-surface border border-gray-700 p-3">
                        <div class="text-[11px] font-semibold text-gray-300 mb-1 flex items-center gap-2">
                            <i class="fa-solid fa-shield-halved text-md-success text-[10px]"></i>
                            Privacy note
                        </div>
                        <p class="text-[12px] text-gray-400">
                            All communication happens locally between your browser and the board.
                            The IDE does not upload your code or firmware to any server.
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
                <button id="welcomeGuideBtn"
                        type="button"
                        data-welcome-guide
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[12px] font-semibold bg-md-primary text-md-onPrimary hover:brightness-110 shadow-md shadow-blue-900/30 transition">
                    <i class="fa-solid fa-book-open text-[11px]"></i>
                    <span>Open getting started guide</span>
                </button>

                <!-- Install as app button (always visible) -->
                <button id="installAppBtn"
                        type="button"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[12px] font-semibold bg-md-surface border border-md-primary text-md-primary hover:bg-md-surface2 transition">
                    <i class="fa-solid fa-download text-[11px]"></i>
                    <span>Install as app</span>
                </button>

                <button type="button"
                        data-welcome-close
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[12px] font-semibold bg-md-surface border border-gray-700 text-gray-200 hover:bg-md-surface2 transition">
                    <i class="fa-solid fa-xmark text-[11px]"></i>
                    <span>Close for now</span>
                </button>
                <button type="button"
                        data-welcome-never
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[12px] font-semibold bg-transparent border border-gray-700 text-gray-400 hover:text-gray-200 hover:bg-white/5 transition">
                    <i class="fa-regular fa-circle-check text-[11px]"></i>
                    <span>Do not show again</span>
                </button>
            </div>

            <!-- Hidden getting-started guide, toggled by button -->
            <div id="welcomeGuide" class="mt-5 rounded-3xl bg-md-surface border border-gray-700 p-4 hidden">
                <h3 class="text-sm font-semibold text-white flex items-center gap-2 mb-2">
                    <span class="w-7 h-7 rounded-2xl bg-md-surface2 flex items-center justify-center text-md-primary">
                        <i class="fa-solid fa-person-running text-[11px]"></i>
                    </span>
                    Getting started
                </h3>
                <ol class="space-y-3 text-[12px] text-gray-200">
                    <li class="flex gap-3">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-md-primary/15 text-md-primary flex items-center justify-center text-[11px] font-bold">
                            1
                        </div>
                        <div>
                            <div class="font-semibold">Connect your device</div>
                            <p class="text-[12px] text-gray-400 mt-1">
                                In the top bar, click <strong>“Connect”</strong>. Choose the serial port that belongs
                                to your MCU and grant browser permission. When connected, the Shell status dot turns green.
                            </p>
                        </div>
                    </li>

                    <li class="flex gap-3">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-md-primary/15 text-md-primary flex items-center justify-center text-[11px] font-bold">
                            2
                        </div>
                        <div>
                            <div class="font-semibold">List and open files</div>
                            <p class="text-[12px] text-gray-400 mt-1">
                                In the Explorer panel on the left:
                            </p>
                            <ul class="mt-1 space-y-1 text-[12px] text-gray-400">
                                <li>• Click the refresh icon to list files on the board.</li>
                                <li>• Click a filename (for example <code>main.py</code>) to open it in the editor.</li>
                                <li>• Use the plus icon to create a new file, and the trash icon to delete the current file.</li>
                            </ul>
                        </div>
                    </li>

                    <li class="flex gap-3">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-md-primary/15 text-md-primary flex items-center justify-center text-[11px] font-bold">
                            3
                        </div>
                        <div>
                            <div class="font-semibold">Edit, save, and run</div>
                            <p class="text-[12px] text-gray-400 mt-1">
                                Edit MicroPython code in the central editor.
                            </p>
                            <ul class="mt-1 space-y-1 text-[12px] text-gray-400">
                                <li>• Click the save icon (or press <code>Ctrl+S</code>) to write the file back to the board.</li>
                                <li>• Click the run icon to send the current file to the board and execute it.</li>
                                <li>• Click stop to send <code>Ctrl+C</code> and interrupt the running program.</li>
                            </ul>
                            <p class="text-[11px] text-gray-500 mt-1">
                                The Shell on the right shows REPL output and lets you type interactive commands.
                            </p>
                        </div>
                    </li>

                    <li class="flex gap-3">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-md-primary/15 text-md-primary flex items-center justify-center text-[11px] font-bold">
                            4
                        </div>
                        <div>
                            <div class="font-semibold">Flash MicroPython firmware (optional)</div>
                            <p class="text-[12px] text-gray-400 mt-1">
                                If your board does not yet have MicroPython installed:
                            </p>
                            <ul class="mt-1 space-y-1 text-[12px] text-gray-400">
                                <li>• Click the yellow lightning icon in the toolbar to open the ESP firmware flasher.</li>
                                <li>• Choose the correct MCU type (ESP32 / ESP32-S3 / ESP32-C3 / ESP32-S2 / ESP8266).</li>
                                <li>• Download the right <code>.bin</code> from the official MicroPython download page.</li>
                                <li>• Drag and drop the file into the flasher area, then click <strong>Flash</strong>.</li>
                            </ul>
                        </div>
                    </li>

                    <li class="flex gap-3">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-md-primary/15 text-md-primary flex items-center justify-center text-[11px] font-bold">
                            5
                        </div>
                        <div>
                            <div class="font-semibold">Troubleshooting tips</div>
                            <ul class="mt-1 space-y-1 text-[12px] text-gray-400">
                                <li>• If you see no output, make sure the board is not in bootloader mode.</li>
                                <li>• Try disconnecting, resetting the board, and connecting again.</li>
                                <li>• Ensure you selected the correct serial port in the browser dialog.</li>
                                <li>• Always save files before resetting or disconnecting the board.</li>
                            </ul>
                        </div>
                    </li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Global loading overlay (hidden by default) -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-md-surface p-6 rounded-3xl shadow-2xl flex flex-col items-center gap-4 border border-gray-800">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-md-primary"></i>
            <span id="loading-text" class="text-sm tracking-wider">Processing...</span>
        </div>
    </div>

<!-- Top bar -->
<div class="h-16 flex items-center justify-between px-4 bg-md-base shrink-0 z-20 border-b border-gray-800">
    <!-- Left: title -->
    <div class="flex items-center gap-3">
        <h1 class="text-lg font-bold text-md-primary tracking-tight">
            Web MicroPython
        </h1>
    </div>

    <!-- Right: toolbar buttons -->
    <div class="flex items-center gap-1">
        <!-- Guide button: reopen welcome modal -->
        <button id="btnShowWelcome"
                class="btn-icon w-8 h-8 text-md-primary hover:bg-white/10"
                onclick="openWelcomeModal()" title="Show welcome guide">
            <i class="fa-regular fa-circle-question"></i>
        </button>

        <!-- Connect -->
        <button id="btnConnect"
                class="bg-md-primary text-md-onPrimary text-xs font-bold px-4 py-1.5 rounded-full hover:brightness-110 transition-all"
                onclick="toggleConnection()">Connect</button>
        
        <!-- Flash tool -->
        <button class="btn-icon w-8 h-8 text-yellow-300 hover:bg-yellow-900/30"
                onclick="openEspFlashModal()" title="ESP series firmware flasher">
            <i class="fa-solid fa-bolt"></i>
        </button>

        <!-- Run -->
        <button id="btnRun" class="btn-icon w-8 h-8 text-green-400 hover:bg-green-900/30 btn-disabled"
                onclick="runScript()" title="Run (F5)">
            <i class="fa-solid fa-play"></i>
        </button>

        <!-- Save -->
        <button id="btnSave" class="btn-icon w-8 h-8 text-blue-400 hover:bg-blue-900/30 btn-disabled"
                onclick="saveFile()" title="Save (Ctrl+S)">
            <i class="fa-solid fa-floppy-disk"></i>
        </button>

        <!-- Download -->
        <button id="btnDownload"
                class="btn-icon w-8 h-8 text-blue-400 hover:bg-blue-900/30 btn-disabled"
                onclick="downloadCurrentFile()" title="Download file">
            <i class="fa-solid fa-download"></i>
        </button>

        <!-- Stop -->
        <button id="btnStop" class="btn-icon w-8 h-8 text-red-400 hover:bg-red-900/30 btn-disabled"
                onclick="stopCode()" title="Stop">
            <i class="fa-solid fa-stop"></i>
        </button>
    </div>
</div>

<!-- Main content -->
<div class="flex-1 flex overflow-hidden relative">
    <!-- Sidebar: Explorer Section -->
    <aside id="sidebar"
        class="absolute inset-y-0 left-0 w-64 bg-transparent z-10 sidebar-mobile sidebar-hidden
                md:relative md:transform-none md:bg-transparent notranslate"
        translate="no">
        <div class="p-2 h-full">
            <!-- Explorer card -->
            <div class="flex flex-col h-full rounded-3xl bg-md-surface2 border border-gray-800
                        shadow-lg overflow-hidden">
                <!-- Explorer header -->
                <div class="px-3 py-2 flex items-center justify-between border-b border-gray-800">
                    <span class="text-xs font-bold text-gray-500 uppercase">Explorer</span>
                    <div class="flex gap-1">
                        <!-- Refresh -->
                        <button id="btnExplorerRefresh" class="btn-icon w-7 h-7"
                                onclick="refreshFileList()">
                            <i class="fa-solid fa-rotate-right text-xs"></i>
                        </button>
                        <!-- New file -->
                        <button class="btn-icon w-7 h-7" onclick="createNewFile()">
                            <i class="fa-solid fa-plus text-xs"></i>
                        </button>
                        <!-- Delete -->
                        <button class="btn-icon w-7 h-7" onclick="deleteCurrentFile()">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                        <!-- Upload -->
                        <button id="btnUpload" class="btn-icon w-7 h-7"
                                onclick="triggerUploadFile()">
                            <i class="fa-solid fa-upload text-xs"></i>
                        </button>
                        <!-- PYPI -->
                        <a href="https://pypi.org/" target="_blank">
                            <button class="btn-icon w-7 h-7">
                                <i class="fa-brands fa-python text-xs"></i>
                            </button>
                        </a>
                    </div>
                </div>

                <!-- Current file info -->
                <div class="px-3 py-2 border-b border-gray-800 bg-md-surface flex items-center justify-between">
                    <div class="flex items-center gap-2 min-w-0 text-xs text-gray-300">
                        <i class="fa-regular fa-file-lines text-md-primary text-[11px]"></i>
                        <span id="currentFileNameLabel" class="truncate notranslate" translate="no">
                            No file opened
                        </span>
                    </div>
                    <button id="btnCloseFileTag"
                            type="button"
                            class="text-gray-500 hover:text-gray-200 text-[10px] hidden"
                            onclick="closeFile()">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <!-- File list -->
                <div id="fileList" class="flex-1 overflow-y-auto pb-4 pt-2 notranslate" translate="no">
                    <div class="flex flex-col items-center justify-center h-40 text-gray-600 gap-2 opacity-50">
                        <i class="fa-regular fa-folder-open text-2xl"></i>
                        <span class="text-xs">Please connect device</span>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-0 hidden md:hidden backdrop-blur-sm" onclick="toggleSidebar()"></div>

    <!-- Content -->
    <main class="flex-1 flex flex-col bg-md-base min-w-0">
        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden p-2 gap-2">
            <!-- Editor -->
            <div class="flex-1 bg-md-surface rounded-2xl overflow-hidden shadow-lg border border-gray-800 relative flex flex-col">
                <div id="editor"
                     class="flex-1 notranslate"
                     translate="no"></div>
                <div id="editor-placeholder" class="absolute inset-0 flex items-center justify-center bg-md-surface z-10 text-gray-600 flex-col gap-3">
                    <i class="fa-brands fa-python text-6xl opacity-20"></i>
                </div>
            </div>

            <!-- Terminal -->
            <div class="h-1/3 lg:h-auto lg:w-[40%] bg-black rounded-2xl overflow-hidden border border-gray-800 p-1 shadow-lg flex flex-col">
                <div class="h-8 flex items-center justify-between px-4 bg-black border-b border-gray-900">
                    <span class="text-[10px] font-bold text-gray-500 uppercase notranslate" translate="no">Shell</span>
                    <div class="flex gap-2 items-center">
                        <span class="text-[10px] text-gray-600">Type below</span>
                        <div class="w-2 h-2 rounded-full bg-red-500" id="termStatusDot"></div>
                    </div>
                </div>
                <div id="terminal-container"
                     class="flex-1 bg-black pl-1 notranslate"
                     translate="no"></div>
            </div>
        </div>
    </main>
</div>

    <!-- ESP series firmware flashing tool window -->
    <div id="espFlashModal" class="esp-flasher-modal">
        <div class="modal-content max-w-xl">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold text-md-primary">ESP Series Firmware Flasher</h2>
                    <p class="text-xs text-gray-500 mt-1">
                        1) Open the <a href="https://micropython.org/download/" target="_blank" class="text-md-primary underline">MicroPython download page</a>,
                        find the correct <code>.bin</code> firmware for your board and download it.<br>
                        2) Select MCU below, then drag that <code>.bin</code> file into the area (or click to choose it).<br>
                        3) Click <strong>Flash</strong> to burn the firmware.
                    </p>
                </div>
                <button class="btn-icon" onclick="toggleModal('espFlashModal', false)">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

                <!-- MCU selector -->
                <div>
                    <label class="text-xs text-gray-400">MCU</label>
                    <select id="chipFamilySelect"
                            class="mt-1 w-full bg-md-surface border border-gray-700 rounded-2xl px-3 py-2 text-xs focus:outline-none focus:border-md-primary">
                        <option value="ESP32">ESP32-WROOM</option>
                        <option value="ESP32-S3">ESP32-S3</option>
                        <option value="ESP32-C3">ESP32-C3</option>
                        <option value="ESP32-S2">ESP32-S2</option>
                        <option value="ESP8266">ESP8266</option>
                    </select>
                    <p class="text-[10px] text-gray-500 mt-1">
                        For most generic ESP32 boards, keep it as <strong>ESP32-WROOM</strong>. For C3 / S3 / S2 / 8266, choose the corresponding option.
                    </p>
                </div>

                <!-- Drag & drop / file select area -->
                <div>
                    <label class="text-xs text-gray-400">Firmware file (.bin)</label>
                    <div id="firmwareDropZone"
                         class="mt-1 border-2 border-dashed border-gray-700 rounded-2xl px-4 py-6 text-center text-xs text-gray-400 cursor-pointer hover:border-md-primary hover:bg-md-surface transition-colors">
                        <input id="firmwareFileInput" type="file" accept=".bin" class="hidden">
                        <div class="flex flex-col items-center gap-2">
                            <i class="fa-solid fa-file-arrow-up text-lg opacity-70"></i>
                            <span>Drag &amp; drop firmware <code>.bin</code> file here,<br>or click to choose from disk</span>
                            <span id="firmwareFileName" class="text-[10px] text-gray-500 mt-1">
                                No file selected
                            </span>
                        </div>
                    </div>
                </div>

                <div class="pt-1">
                    <!-- ESP Web Tools install button; manifest will be set dynamically from local file -->
                    <esp-web-install-button id="espInstaller">
                        <button
                            slot="activate"
                            class="bg-md-primary text-md-onPrimary text-xs font-bold px-4 py-1.5 rounded-full hover:brightness-110 transition-all flex items-center gap-2"
                        >
                            <i class="fa-solid fa-bolt text-xs"></i>
                            <span>Flash</span>
                        </button>
                    </esp-web-install-button>
                    <p class="text-[10px] text-gray-500 mt-2">
                        Once a firmware file is selected, a temporary manifest is generated in memory and attached
                        here. Then you can connect to the board and flash it directly.
                    </p>
                </div>

                <div class="border-t border-gray-700 pt-3 mt-1">
                    <p class="text-[10px] text-gray-500">
                        The selected local firmware file is wrapped into a temporary manifest JSON and referenced
                        via a <code>blob:</code> URL, so you do not need to host <code>esp-manifest.json</code> on a server.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= Global state =================
        let currentFilename = null;
        let isConnected = false;
        let currentAdapter = null;
        let selectedFirmwareFile = null;

        // PWA install prompt cache
        let deferredInstallPrompt = null;

        // Handle beforeinstallprompt: browser detected that app can be installed
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
        });

        // When app installed, hide the install button (optional)
        window.addEventListener('appinstalled', () => {
            deferredInstallPrompt = null;
            const installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
                installBtn.classList.add('btn-disabled');
            }
        });

        // UI helpers
        function showLoading(show, txt) {
            const el = document.getElementById('loading-overlay');
            if (show) {
                el.classList.remove('hidden');
                document.getElementById('loading-text').innerText = txt || "Processing...";
            } else {
                el.classList.add('hidden');
            }
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if (!el) return;
            if (show) {
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('show'), 10);
            } else {
                el.classList.remove('show');
                setTimeout(() => el.classList.add('hidden'), 300);
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            sb.classList.toggle('sidebar-hidden');
            if (sb.classList.contains('sidebar-hidden')) ov.classList.add('hidden');
            else ov.classList.remove('hidden');
        }

        function openWelcomeModal() {
            toggleModal('welcomeModal', true);
        }

        // ================= Editor & Terminal =================
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/tomorrow_night_eighties");
        editor.session.setMode("ace/mode/python");
        editor.setFontSize(14);
        editor.setReadOnly(true);

        const termContainer = document.getElementById('terminal-container');
        const term = new Terminal({
            cursorBlink: true,
            theme: { background: '#000000', foreground: '#d4d4d4' },
            fontFamily: 'Consolas, monospace',
            fontSize: 13
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(termContainer);

        function fitTerminal() {
            const dims = fitAddon.proposeDimensions();
            if (dims) {
                const cols = dims.cols;
                const rows = Math.max(1, dims.rows - 1);
                term.resize(cols, rows);
                term.scrollToBottom();
            }
        }

        fitTerminal();
        new ResizeObserver(() => { fitTerminal(); }).observe(termContainer);
        window.addEventListener('resize', fitTerminal);

        // ================= Serial Adapter =================
        class SerialAdapter {
            constructor() {
                this.port = null;
                this.reader = null;
                this.writer = null;
                this.keepReading = false;
                this.internalBuffer = "";
                this.isInternal = false;
            }
            
            async connect() {
                if (!navigator.serial) throw new Error("Current browser does not support Web Serial");
                this.port = await navigator.serial.requestPort();
                await this.port.open({ baudRate: 115200 });
                await this.port.setSignals({ dataTerminalReady: false, requestToSend: false });
                const enc = new TextEncoderStream();
                const dec = new TextDecoderStream();
                enc.readable.pipeTo(this.port.writable);
                this.port.readable.pipeTo(dec.writable);
                this.writer = enc.writable.getWriter();
                this.reader = dec.readable.getReader();
                this.keepReading = true;
                this.readLoop();
                await this.write('\x03\x03');
                await delay(100);
            }
            
            async disconnect() {
                this.keepReading = false;
                try { await this.reader.cancel(); } catch(e){}
                try { await this.writer.close(); } catch(e){}
                try { await this.port.close(); } catch(e){}
            }
            
            async readLoop() {
                while (this.port?.readable && this.keepReading) {
                    try {
                        const { value, done } = await this.reader.read();
                        if (done) break;
                        if (value) this.isInternal ? (this.internalBuffer += value) : term.write(value);
                    } catch (e) { break; }
                }
            }
            
            async write(d) {
                if (this.writer) await this.writer.write(d);
            }
            
            async execInternal(code) {
                this.isInternal = true;
                this.internalBuffer = "";
                try {
                    await this.write('\x03\x01'); // Raw REPL
                    await delay(50);
                    this.internalBuffer = "";
                    await this.write(code + '\x04');
                    for (let i = 0; i < 150; i++) {
                        if (this.internalBuffer.includes('\x04>')) break;
                        await delay(50);
                    }
                    await this.write('\x02'); // Exit raw REPL
                } catch (e) {
                } finally {
                    this.isInternal = false;
                }
                
                const raw = this.internalBuffer;
                const okIdx = raw.indexOf('OK');
                if (okIdx !== -1) {
                    const parts = raw.substring(okIdx + 2).split('\x04');
                    if (parts[1]) console.error("Exec Error:", parts[1]);
                    return parts[0];
                }
                return null;
            }

            async listFiles() {
                const res = await this.execInternal("import os; print(os.listdir())");
                return res ? JSON.parse(res.trim().replace(/'/g, '\"')) : [];
            }
            async readFile(fn) {
                const code =
`import ubinascii
try:
 with open('${fn}','rb') as f: print(ubinascii.b2a_base64(f.read()).decode('utf-8'),end='')
except:
 print('')`;
                const b64 = await this.execInternal(code);
                if (!b64) return "";
                try {
                    const decoded = window.atob(b64.trim());
                    return decodeURIComponent(escape(decoded));
                } catch (e) {
                    console.error("Decode error:", e);
                    return "";
                }
            }
            async saveFile(fn, txt) {
                const b64 = btoa(unescape(encodeURIComponent(txt)));
                await this.execInternal(
`import ubinascii
with open('${fn}','wb') as f: f.write(ubinascii.a2b_base64('${b64}'))`
                );
            }
            async deleteFile(fn) {
                await this.execInternal(`import os; os.remove('${fn}')`);
            }
        }

        // ================= Logic Control =================

        async function toggleConnection() {
            if (isConnected) {
                if (currentAdapter) await currentAdapter.disconnect();
                isConnected = false;
                resetUI();
            } else {
                currentAdapter = new SerialAdapter();
                try {
                    showLoading(true, "Connecting...");
                    await currentAdapter.connect();
                    isConnected = true;
                    updateUIConnected();
                } catch (e) {
                    alert(e.message || e);
                    isConnected = false;
                    resetUI();
                } finally {
                    showLoading(false);
                }
            }
        }

        async function refreshFileList() {
            if (!currentAdapter) return;
            showLoading(true, "Syncing files...");
            try {
                const files = await currentAdapter.listFiles();
                const list = document.getElementById('fileList');
                list.innerHTML = "";
                files.forEach(f => {
                    const div = document.createElement('div');
                    div.className = `file-item ${f === currentFilename ? 'active' : ''}`;
                    div.innerHTML = `<i class="fa-brands fa-python"></i> ${f}`;
                    div.onclick = () => openFile(f);
                    list.appendChild(div);
                });
            } finally {
                showLoading(false);
            }
        }

        function triggerUploadFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.py';
            fileInput.onchange = (event) => handleFileUpload(event);
            fileInput.click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (currentAdapter) {
                    const fileContent = await file.text();
                    await currentAdapter.saveFile(file.name, fileContent);
                    refreshFileList();
                }
            }
        }

        function downloadCurrentFile() {
            if (!currentFilename || !currentAdapter) return;
            const fileContent = editor.getValue();
            const blob = new Blob([fileContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function updateCurrentFileDisplay() {
            const label = document.getElementById('currentFileNameLabel');
            const closeBtn = document.getElementById('btnCloseFileTag');
            const btns = ['btnRun', 'btnSave', 'btnStop', 'btnDownload'];

            if (!label || !closeBtn) return;

            if (currentFilename) {
                label.textContent = currentFilename;
                closeBtn.classList.remove('hidden');
                btns.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('btn-disabled');
                });
            } else {
                label.textContent = 'No file opened';
                closeBtn.classList.add('hidden');
                btns.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('btn-disabled');
                });
            }

            const fileList = document.getElementById('fileList');
            if (fileList) {
                [...fileList.querySelectorAll('.file-item')].forEach(div => {
                    const name = div.textContent.trim();
                    if (name === currentFilename) {
                        div.classList.add('active');
                    } else {
                        div.classList.remove('active');
                    }
                });
            }
        }

        async function openFile(fn) {
            if (!currentAdapter) return;
            currentFilename = fn;
            showLoading(true, "Reading file...");
            try {
                const txt = await currentAdapter.readFile(fn);
                editor.setValue(txt, -1);
                editor.setReadOnly(false);
                document.getElementById('editor-placeholder').classList.add('hidden');
                updateCurrentFileDisplay();
            } catch (e) {
                console.error(e);
                alert("Failed to read file: " + (e.message || e));
            } finally {
                showLoading(false);
            }
        }

        async function saveFile() {
            if (!currentFilename || !currentAdapter) return;
            showLoading(true, "Saving file...");
            try {
                await currentAdapter.saveFile(currentFilename, editor.getValue());
            } finally {
                showLoading(false);
            }
        }

        async function createNewFile() {
            if (!currentAdapter) {
                alert("Please connect to device first");
                return;
            }
            const n = prompt("New file name:");
            if (n) {
                currentFilename = n;
                editor.setValue("", -1);
                await saveFile();
                await openFile(n);
                await refreshFileList();
            }
        }
        
        async function deleteCurrentFile() {
            if (currentFilename && currentAdapter && confirm("Delete this file?")) {
                await currentAdapter.deleteFile(currentFilename);
                closeFile();
                refreshFileList();
            }
        }

        function closeFile() {
            currentFilename = null;
            editor.setValue("", -1);
            editor.setReadOnly(true);
            const ph = document.getElementById('editor-placeholder');
            if (ph) ph.classList.remove('hidden');
            updateCurrentFileDisplay();
        }

        async function runScript() {
            if (!currentAdapter || !currentFilename) return;
            term.write('\r\n>>> Run\r\n');
            await currentAdapter.write('\x03');
            await delay(50);
            await currentAdapter.write('\x05');
            const code = editor.getValue();
            const chunk = 1024;
            for (let i = 0; i < code.length; i += chunk) {
                await currentAdapter.write(code.substring(i, i + chunk));
            }
            await currentAdapter.write('\x04');
        }

        async function stopCode() {
            if (currentAdapter) {
                await currentAdapter.write('\x03\x03');
            }
        }

        function resetUI() {
            const btn = document.getElementById('btnConnect');
            btn.className = "bg-md-primary text-md-onPrimary text-xs font-bold px-4 py-1.5 rounded-full";
            btn.innerText = "Connect";
            document.getElementById('termStatusDot').className = "w-2 h-2 rounded-full bg-red-500";
            closeFile();
        }
        function updateUIConnected() {
            const btn = document.getElementById('btnConnect');
            btn.className = "bg-md-danger text-white text-xs font-bold px-4 py-1.5 rounded-full";
            btn.innerText = "Disconnect";
            document.getElementById('termStatusDot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]";
        }
        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
        
        term.onData(d => { if (isConnected && currentAdapter) currentAdapter.write(d); });

        // ================= ESP flasher helpers =================

        async function openEspFlashModal() {
            try {
                if (isConnected && currentAdapter) {
                    await currentAdapter.disconnect();
                    isConnected = false;
                    resetUI();
                }
            } catch (e) {
                console.warn("Failed to disconnect existing serial port:", e);
            }
            toggleModal('espFlashModal', true);
        }

        const dropZone = document.getElementById('firmwareDropZone');
        const fileInput = document.getElementById('firmwareFileInput');
        const fileNameLabel = document.getElementById('firmwareFileName');

        if (dropZone && fileInput) {
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('border-md-primary', 'bg-md-surface');
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-md-primary', 'bg-md-surface');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-md-primary', 'bg-md-surface');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFirmwareFile(e.dataTransfer.files[0]);
                    e.dataTransfer.clearData();
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    handleFirmwareFile(e.target.files[0]);
                }
            });
        }

        function handleFirmwareFile(file) {
            selectedFirmwareFile = file;
            fileNameLabel.innerText = file.name + " (" + Math.round(file.size / 1024) + " KB)";
            prepareManifestFromLocalFile(file);
        }

        function getOffsetsForChip(chip) {
            if (chip === "ESP32") return 0x1000;
            return 0x0;
        }

        async function prepareManifestFromLocalFile(file) {
            try {
                showLoading(true, "Preparing firmware manifest...");
                const chipSelect = document.getElementById("chipFamilySelect");
                const chipFamily = chipSelect ? (chipSelect.value || "ESP32") : "ESP32";
                const offset = getOffsetsForChip(chipFamily);

                const firmwareUrl = URL.createObjectURL(file);

                const manifestObj = {
                    name: file.name || "Local firmware",
                    version: "local",
                    new_install_prompt_erase: true,
                    builds: [
                        {
                            chipFamily: chipFamily,
                            improv: false,
                            parts: [
                                {
                                    path: firmwareUrl,
                                    offset: offset
                                }
                            ]
                        }
                    ]
                };

                const blob = new Blob([JSON.stringify(manifestObj)], { type: "application/json" });
                const manifestUrl = URL.createObjectURL(blob);

                const btn = document.getElementById("espInstaller");
                if (btn) {
                    btn.setAttribute("manifest", manifestUrl);
                } else {
                    alert("ESP install button component not found.");
                }
            } catch (e) {
                console.error(e);
                alert("Failed to prepare manifest from local file: " + (e.message || e));
            } finally {
                showLoading(false);
            }
        }

        // ================= Welcome overlay init =================
        function initWelcomeOverlay() {
            const modal = document.getElementById('welcomeModal');
            if (!modal) return;

            const STORAGE_KEY = 'web-micropython-hide-welcome';
            let hideForever = false;

            try {
                hideForever = localStorage.getItem(STORAGE_KEY) === '1';
            } catch (e) {
                console.warn('Unable to read localStorage for welcome modal:', e);
            }

            if (!hideForever) {
                toggleModal('welcomeModal', true);
            }

            const closeButtons = modal.querySelectorAll('[data-welcome-close]');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    toggleModal('welcomeModal', false);
                });
            });

            const neverButtons = modal.querySelectorAll('[data-welcome-never]');
            neverButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    try {
                        localStorage.setItem(STORAGE_KEY, '1');
                    } catch (e) {
                        console.warn('Unable to write localStorage for welcome modal:', e);
                    }
                    toggleModal('welcomeModal', false);
                });
            });

            const guideBtn = modal.querySelector('[data-welcome-guide]');
            const guide = document.getElementById('welcomeGuide');
            if (guideBtn && guide) {
                guideBtn.addEventListener('click', () => {
                    const isHidden = guide.classList.contains('hidden');
                    if (isHidden) {
                        guide.classList.remove('hidden');
                        guideBtn.innerHTML = '<i class="fa-solid fa-book-open text-[11px]"></i><span>Hide getting started guide</span>';
                    } else {
                        guide.classList.add('hidden');
                        guideBtn.innerHTML = '<i class="fa-solid fa-book-open text-[11px]"></i><span>Open getting started guide</span>';
                    }
                });
            }

            const installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (deferredInstallPrompt) {
                        deferredInstallPrompt.prompt();
                        const choice = await deferredInstallPrompt.userChoice;
                        if (choice.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        } else {
                            console.log('User dismissed the install prompt');
                        }
                        deferredInstallPrompt = null;
                    } else {
                        alert('Install prompt is not available.\nYou can also use your browser menu to install this app (e.g. "Install app" or "Add to home screen").');
                    }
                });
            }
        }

        // Register service worker (for offline support)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('Service worker registration failed:', err);
                });
            });
        }

        // Initialize welcome overlay after everything is defined
        initWelcomeOverlay();
    </script>
</body>
</html>


